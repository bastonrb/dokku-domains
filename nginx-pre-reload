#!/usr/bin/env ruby
puts "Domain: #{ENV['DOMAIN']}"
puts "Root: #{ENV['DOKKU_ROOT']}"
puts "App: #{ENV['App']}"

conf ="#{ENV['DOKKU_ROOT']}/#{ENV['APP']}/nginx.conf"

if (ENV["DOMAIN"] && File.exists?(conf))
  conf_content = File.read(conf) 
  /server_name (.*);/.match(conf_content)
  new_server_name = "#{ENV['DOMAIN']} #{$1}"
  conf_content.gsub!($1,new_server_name)
  File.delete(conf)
  File.open(conf, "w") { |file| file.write conf_content}
  `sudo /etc/init.d/nginx reload > /dev/null`  
  puts "#{ENV["DOMAIN"]} has been added!"
else
  puts "can not find #{conf}" unless File.exists? (conf)
  puts "no domain specified!" unless ENV['DOMAIN']
end


  